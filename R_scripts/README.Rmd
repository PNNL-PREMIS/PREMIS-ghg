---
output:
  github_document:
    html_preview: false
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r knitrsetup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/README-"
)
options(tibble.print_min = 5, tibble.print_max = 5)
```

# PREMIS-ghg
### Soil GHG experiment

#### Motivation
Disturbances such as sea level rise, increased extreme weather events, and climate change can have lasting impacts on terrestrial ecosystems. Monitoring greenhouse gas fluxes at the terrestrial-aquatic interface offers a way to quantify the stability and resilience of terrestrial soils in a stressed environment. 

#### Design
We are testing soil response to salt water intrusion by monitoring soil respiration rates along a creek transect at the [Smithsonian Environmental Research Center (SERC)](https://serc.si.edu/). We have transplanted soil cores (40 cm diameter, 20 cm depth) along a salinity and elevation gradient at three locations (~1 km between salinity plots, ~50 m between elevation plots). This design will also be replicated on the west coast at Beaver Creek. We hypothesize that an increase in salinity will *suppress* soil CO2 respiration, but not affect methane production.   

More info [here!](https://osf.io/at9hr)

![](https://github.com/PNNL-PREMIS/PREMIS-ghg/blob/master/photos/cores_in_cart.jpeg) ![](https://github.com/PNNL-PREMIS/PREMIS-ghg/blob/master/photos/BBL_SP_snow.jpeg) ![](https://github.com/PNNL-PREMIS/PREMIS-ghg/blob/master/photos/cores_in_ground.jpeg)

# Real-time data diagnostics

**Last run: `r date()`**

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(drake)
library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_bw())
```


```{r prep, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}

# Load the licor and weather data
licor_data <- readd("licor_data")
licor_daily_data <- readd("licor_daily_data")
weather_data <- readd("weather_data")

# Calculate treatments means and s.d.
licor_daily_data %>% 
  mutate(ControlGroup = if_else(Group == "Control", "Control (true)", "Transplant")) %>% 
  group_by(Experiment, Origin_Plot, Dest_Salinity, Dest_Elevation, 
           Destination_Plot, Date, Group, ControlGroup) %>%  
  summarise(Timestamp = mean(Timestamp), 
            sdFlux = sd(meanFlux), 
            meanFlux = mean(meanFlux), 
            meanSM = mean(meanSM)) %>% 
  ungroup %>% 
  mutate(Experiment = if_else(Origin_Plot == Destination_Plot, "Control", Experiment),
         Dest_Elevation = paste(Dest_Elevation, "elevation"),
         Dest_Salinity = paste(Dest_Salinity, "salinity"),
         Dest_Elevation = factor(Dest_Elevation, levels = c("High elevation", "Medium elevation", "Low elevation")),
         Dest_Salinity = factor(Dest_Salinity, levels = c("Low salinity", "Medium salinity", "High salinity"))) ->
  daily_treatment_means
```

```{r sample_size_table, echo = FALSE, message = FALSE}
# Auto-generate the sample size table
readd("collar_data") %>% 
  group_by(Site, Experiment) %>% 
  summarise(N = n()) %>% 
  knitr::kable()
```

## IRGA data

### CO2 flux over time
```{r co2_time, echo = FALSE, warning = FALSE, fig.width=8}
daily_treatment_means %>% 
  filter(!is.na(meanFlux), !is.na(sdFlux)) %>% 
  ggplot(aes(x = Timestamp, y = meanFlux, color = Experiment, group = Group)) +
  geom_errorbar(aes(ymin = meanFlux - sdFlux, ymax = meanFlux + sdFlux)) +
  geom_point() +
  geom_line(aes(linetype = ControlGroup)) +
  facet_grid(Dest_Elevation ~ Dest_Salinity) +
  ggtitle("Flux over time - destination plots") +
  labs(x = "Date", y = expression(Flux~(Âµmol~CO[2]~m^-2~s^-1))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
