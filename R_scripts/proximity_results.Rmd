---
title: "proximity_results"
author: "SP"
date: "October 24, 2018"
output: html_document
---

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
# Define functions

basal_area_sum <- function(data, distance) {
  data %>% 
    filter(Distance_m <= distance) %>% 
    group_by(Collar) %>% 
    summarise(n_trees = n(), BA_m2 = round(sum(BA_sqm, na.rm = TRUE), digits = 3), dist = distance)
}

prox_model <- function(flux, T5, T20, SM, BA, site) {
  # Fit model
  nlme::lme(log(flux) ~ T5 + T20 + SM + I(SM ^ 2) + BA, 
            random = ~ 1 | site,
            method = "ML")
  
  # Remove non-significant variables
  
  
  # Return model
}

```

### Table 1
```{r, echo = FALSE, warning = FALSE, message = FALSE}

readd("tree_data") %>% 
  group_by(Site, Salinity, Elevation) %>% 
  summarise(n = n(), Plot_area_m2 = mean(Plot_area_m2), `BA (m2/ha)` = sum((DBH_cm / 100 / 2) ^ 2 * pi, na.rm = TRUE) / mean(Plot_area_m2) * 10000) %>% 
  mutate(`Trees (/ha)` = n / Plot_area_m2 * 10000) %>% 
  summarise(tree_mean = mean(`Trees (/ha)`), tree_sd = sd(`Trees (/ha)`), BA_mean = mean(`BA (m2/ha)`), BA_sd = sd(`BA (m2/ha)`)) ->
  x

# Site info
x$tree_mean <- round(x$tree_mean, digits = 1)
x$tree_sd <- round(x$tree_sd, digits = 1)
x$BA_mean <- round(x$BA_mean, digits = 1)
x$BA_sd <- round(x$BA_sd, digits = 1)
x$Salinity <- sub("Salinity H", "High", x$Salinity)
x$Salinity <- sub("Salinity M", "Medium", x$Salinity)
x$Salinity <- sub("Salinity L", "Low", x$Salinity)

x %>% 
  unite(col = 'Trees (/ha)', tree_mean, tree_sd, sep = " ± ") %>%
  unite(col = 'BA (m2/ha)', BA_mean, BA_sd, sep = " ± ") %>%
  knitr::kable(digits = 1, format = "html", col.names = c("Site", "Salinity", "Trees (/ha)", expression(BA~(m^2~ha^-1)))) %>%
  kableExtra::kable_styling(c("striped", "bordered"), full_width = FALSE)
```

### Hypothesis I - BA strong effect within 5 meters
```{r, echo = FALSE, warning = FALSE}
# Site info
licor_data <- readd("licor_data")
treeProxDat <- readd("treeProxDat")

# Filter Licor data for only true control collars
control_cols <- filter(licor_data, Experiment == "Control", is.na(Notes), Dest_Salinity == "High")
BA5 <- basal_area_sum(treeProxDat, 5)
control_cols <- left_join(control_cols, BA5, by = "Collar")

control_cols <- filter(control_cols, SMoisture > 0, SMoisture < 1)
p1 <- lm(log(Flux) ~ T5 + T20 + SMoisture + I(SMoisture ^ 2) +BA_m2, data = control_cols)
summary(p1)
plot(p1)
control_cols$prediction <- predict(p1)
ggplot(control_cols, aes(Timestamp, Flux)) + geom_point() + geom_line(aes(y = exp(prediction))) + facet_wrap(~Collar)
```

### Table 2
```{r, echo = FALSE, warning = FALSE, message = FALSE}
knitr::kable(p1$coefficients, digits = 3, format = "html") %>%
  kableExtra::kable_styling(c("striped", "bordered"), full_width = FALSE)
```

### Hypothesis II - growing vs. dormant season
```{r, echo = FALSE, warning = FALSE}

# Filter true controls for growing season

# Filter true controls for dormant season

```

### Hypothesis III - moisture-limited times
```{r, echo = FALSE, warning = FALSE}

# Filter true controls for soil moisture < x

```

### Sensitivity test - BA significance with distance
```{r, echo = FALSE, warning = FALSE}

```
