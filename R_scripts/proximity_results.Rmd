---
title: "proximity_results"
author: "SP"
date: "October 24, 2018"
output: html_document
---

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
library(readr)
# Load data
licorDat <- get(load("../outputs/licordat.rda"))
treeProxDat <- read_csv("../inventory_data/collar_to_tree_prox.csv")
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
# Define functions
basal_area_sum <- function(data, distance) {
  data %>% 
    filter(Distance_m <= distance) %>% 
    group_by(Collar) %>% 
    summarise(n_trees = n(), BA_m2 = round(sum(BA_sqm, na.rm = TRUE), digits = 3), dist = distance)
}

prox_model <- function(flux, T5, T20, SM, site) {
  # Fit model
  nlme::lme(log(flux) ~ T5 + T20 + SM + I(SM ^ 2), 
                      random = ~ 1 | site,
                      method = "ML")
  
  # Remove non-significant variables
  
  
  # Return model
}

```

### Table 1
```{r, echo = FALSE, warning = FALSE, message = FALSE}
# Site info
library(dplyr)
library(tidyr)

x <- read.csv("../outputs/tree_table.csv")
x$tree_mean <- round(x$tree_mean, digits = 1)
x$tree_sd <- round(x$tree_sd, digits = 1)
x$BA_mean <- round(x$BA_mean, digits = 1)
x$BA_sd <- round(x$BA_sd, digits = 1)
x$Salinity <- sub("Salinity H", "High", x$Salinity)
x$Salinity <- sub("Salinity M", "Medium", x$Salinity)
x$Salinity <- sub("Salinity L", "Low", x$Salinity)

x %>% 
  unite(col = 'Trees (/ha)', tree_mean, tree_sd, sep = " ± ") %>%
  unite(col = 'BA (m2/ha)', BA_mean, BA_sd, sep = " ± ") %>%
  knitr::kable(digits = 1, format = "html", col.names = c("Site", "Salinity", "Trees (/ha)", expression(BA~(m^2~ha^-1)))) %>%
  kableExtra::kable_styling(c("striped", "bordered"), full_width = F)
```

### Hypothesis I - BA strong effect within 5 meters
```{r, echo = FALSE, warning = FALSE}

# Filter Licor data for only true control collars
control_cols <- filter(licorDat, Experiment == "Control" & is.na(Notes))
BA5 <- basal_area_sum(treeProxDat, 5)
prox_model(control_cols$Flux, control_cols$T5, control_cols$T20, control_cols$SMoisture, BA5$BA_m2, control_cols$Destination_Plot)

```

### Hypothesis II - growing vs. dormant season
```{r, echo = FALSE, warning = FALSE}

# Filter true controls for growing season

# Filter true controls for dormant season

```

### Hypothesis III - moisture-limited times
```{r, echo = FALSE, warning = FALSE}

# Filter true controls for soil moisture < x

```

### Sensitivity test - BA significance with distance
```{r, echo = FALSE, warning = FALSE}

```