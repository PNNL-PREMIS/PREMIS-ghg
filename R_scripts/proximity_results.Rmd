---
title: "proximity_results"
author: "SP"
date: "October 24, 2018"
output: html_document
---

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
library(drake)
library(dplyr)
library(tidyr)
library(ggplot2)
library(broom)

# Define functions

basal_area_sum <- function(data, distance) {
  data %>% 
    filter(Distance_m <= distance) %>% 
    group_by(Collar) %>% 
    summarise(n_trees = n(), BA_m2 = round(sum(BA_sqm, na.rm = TRUE), digits = 3), dist = distance)
}

prox_model <- function(flux, T5, T20, SM, BA, site) {
  # Fit model
  
  lm(log(flux) ~ T5 + T20 + SM + I(SM ^ 2) + BA)
  
  # m1 <- lme4::lmer(log(Flux) ~ T5 + T20 + SMoisture + I(SMoisture ^ 2) + (BA_m2 | Dest_Salinity), data = control_cols)


  # Remove non-significant variables
  
  
  # Return model
}

```

```{r joindata}
tree_data <- readd("tree_data")
prox_data <- readd("prox_data")

prox_data %>%
  select(-Date) %>% 
  mutate(Tag = as.character(Tag)) %>%
  left_join(tree_data, by = c("Site", "Plot", "Tag"), na_matches = "never") %>%
# Replace DBH with recorded value for non-tagged trees
  mutate(DBH_cm = if_else(is.na(Tag), No_tag_DBH, DBH_cm),
         Species_code = if_else(is.na(Tag), No_tag_species, Species_code)) %>%
  mutate(BA_sqm = (DBH_cm / 100 / 2) ^ 2 * pi) ->  # from DBH (cm) to area (m2)
 tree_prox_data
```

```{r}
# Calculate cumulative basal area at each distance 
BA_dat <- list()
for (i in 1:max(tree_prox_data$Distance_m)) {
  tree_prox_data %>% 
    filter(Distance_m <= i) %>% 
    group_by(Collar) %>% 
    summarise(n_trees = n(), BA_m2 = sum(BA_sqm, na.rm = TRUE), dist = i) ->
    BA_dat[[i]]
}

BA_dat <- bind_rows(BA_dat)
ggplot(BA_dat, aes(x = dist, y = BA_m2, group = Collar, color = n_trees)) + 
  geom_line(size = 1) +
  xlab("Distance (meters)") +
  ylab("Basal Area (m2)")

```


### Table 1 - site info
```{r, echo = FALSE, warning = FALSE, message = FALSE}
tree_data %>% 
  group_by(Site, Salinity, Elevation) %>% 
  summarise(n = n(), Plot_area_m2 = mean(Plot_area_m2), `BA (m2/ha)` = sum((DBH_cm / 100 / 2) ^ 2 * pi, na.rm = TRUE) / mean(Plot_area_m2) * 10000) %>% 
  mutate(`Trees (/ha)` = n / Plot_area_m2 * 10000) %>% 
  summarise(tree_mean = mean(`Trees (/ha)`), tree_sd = sd(`Trees (/ha)`), BA_mean = mean(`BA (m2/ha)`), BA_sd = sd(`BA (m2/ha)`)) ->
  x

# Site info
x$tree_mean <- round(x$tree_mean, digits = 1)
x$tree_sd <- round(x$tree_sd, digits = 1)
x$BA_mean <- round(x$BA_mean, digits = 1)
x$BA_sd <- round(x$BA_sd, digits = 1)
x$Salinity <- sub("Salinity H", "High", x$Salinity)
x$Salinity <- sub("Salinity M", "Medium", x$Salinity)
x$Salinity <- sub("Salinity L", "Low", x$Salinity)

x %>% 
  unite(col = 'Trees (/ha)', tree_mean, tree_sd, sep = " ± ") %>%
  unite(col = 'BA (m2/ha)', BA_mean, BA_sd, sep = " ± ") %>%
  knitr::kable(digits = 1, format = "html", col.names = c("Site", "Salinity", "Trees (/ha)", expression(BA~(m^2~ha^-1)))) %>%
  kableExtra::kable_styling(c("striped", "bordered"), full_width = FALSE)
```

```{r co2_time, echo = FALSE, warning = FALSE}
licor_daily_data <- readd("licor_daily_data")

# Calculate treatments means and s.d.
licor_daily_data %>% 
  mutate(ControlGroup = if_else(Group == "Control", "Control (true)", "Transplant")) %>% 
  group_by(Experiment, Origin_Plot, Dest_Salinity, Dest_Elevation, 
           Destination_Plot, Date, Group, ControlGroup) %>%  
  summarise(Timestamp = mean(Timestamp), 
            sdFlux = sd(meanFlux), 
            meanFlux = mean(meanFlux), 
            meanSM = mean(meanSM)) %>% 
  ungroup %>% 
  mutate(Experiment = if_else(Origin_Plot == Destination_Plot, "Control", Experiment),
         Dest_Elevation = paste(Dest_Elevation, "elevation"),
         Dest_Salinity = paste(Dest_Salinity, "salinity"),
         Dest_Elevation = factor(Dest_Elevation, levels = c("High elevation", "Medium elevation", "Low elevation")),
         Dest_Salinity = factor(Dest_Salinity, levels = c("Low salinity", "Medium salinity", "High salinity"))) ->
  daily_treatment_means

daily_treatment_means %>% 
  filter(!is.na(meanFlux), !is.na(sdFlux)) %>% 
  filter(ControlGroup == "Control (true)") %>%
  ggplot(aes(x = Timestamp, y = meanFlux, color = Experiment, group = Group)) +
  geom_errorbar(aes(ymin = meanFlux - sdFlux, ymax = meanFlux + sdFlux, color = "tomato4")) +
  geom_point(color = "tomato3") +
  geom_line(size = 1, color = "tomato3") +
  facet_grid(Dest_Elevation ~ Dest_Salinity) +
  ggtitle("Flux over time - destination plots") +
  labs(x = "Date", y = expression(Flux~(µmol~CO[2]~m^-2~s^-1))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```



### Hypothesis I - BA strong effect within 5 meters
```{r, echo = FALSE, warning = FALSE}
# Site info
licor_data <- readd("licor_data")

# Filter Licor data for only true control collars
control_cols <- filter(licor_data, Experiment == "Control", is.na(Notes))
control_cols <- filter(control_cols, SMoisture > 0, SMoisture < 1)

BA5 <- basal_area_sum(tree_prox_data, 5)
control_cols_5m <- left_join(control_cols, BA5, by = "Collar")
control_cols_5m <- filter(control_cols_5m, !is.na(BA_m2))

p1 <- with(control_cols_5m, prox_model(Flux, T5, T20, SMoisture, BA_m2, Site))
summary(p1)
plot(p1)
control_cols_5m$prediction <- predict(p1)
ggplot(control_cols_5m, aes(Timestamp, Flux)) + geom_point() + geom_line(aes(y = exp(prediction))) + facet_wrap(~Collar)
```

### Table 2
```{r, echo = FALSE, warning = FALSE, message = FALSE}
knitr::kable(tidy(p1), digits = 3, format = "html") %>%
  kableExtra::kable_styling(c("striped", "bordered"), full_width = FALSE)
```

### Hypothesis II - growing vs. dormant season
```{r, echo = FALSE, warning = FALSE}

# Filter true controls for growing season

# Filter true controls for dormant season

```

### Hypothesis III - moisture-limited times
```{r, echo = FALSE, warning = FALSE}

# Filter true controls for soil moisture < x

```

### Sensitivity test - BA significance with distance
```{r, echo = FALSE, warning = FALSE}

sens_output <- list()
BA_output <- list()
for (i in 2:15) {
  BA <- basal_area_sum(tree_prox_data, i)
  data <- left_join(control_cols, BA, by = "Collar") %>% filter(!is.na(BA_m2))
  
  model <- prox_model(data$Flux, data$T5, data$T20, data$SMoisture, data$BA_m2, data$Site)
  ichar <- as.character(i)
  sens_output[[ichar]] <- tidy(model)
  BA_output[[ichar]] <- filter(sens_output[[ichar]], term == "BA")
}
bind_rows(sens_output, .id = "Distance") %>%
  filter(term == "BA") %>%
  mutate(Distance = as.integer(Distance)) %>%
  print %>%
  ggplot(aes(Distance, p.value)) + geom_line() + geom_hline(yintercept = 0.05, linetype = 2) +
  xlab("Radius of distance from collar considered") + ylab("p-value for test of BA significance to flux")
```
