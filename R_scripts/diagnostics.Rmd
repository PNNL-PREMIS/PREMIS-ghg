---
author: "SPennington"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Diagnostics as of `r date()`

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}

# Load the licor data and calculate daily means
licor_data <- readd("licor_data")
licor_daily_data <- readd("licor_daily_data")

# Calculate treatments means and s.d.
licor_daily_data %>% 
  mutate(ControlGroup = if_else(Group == "Control", "Control (true)", "Transplant")) %>% 
  group_by(Experiment, Origin_Plot, Dest_Salinity, Dest_Elevation, Destination_Plot,
           Date, Group, ControlGroup) %>%  
  summarise(Timestamp = mean(Timestamp), 
            sdFlux = sd(meanFlux), 
            meanFlux = mean(meanFlux), 
            meanSM = mean(meanSM)) %>% 
  ungroup %>% 
  mutate(Experiment = if_else(Origin_Plot == Destination_Plot, "Control", Experiment)) ->
  daily_treatment_means
```

```{r, echo = FALSE, message = FALSE}
# Auto-generate the sample size table
readd("collar_data") %>% 
  group_by(Site, Experiment) %>% 
  summarise(N = n()) %>% 
  knitr::kable()
```


### CO2 flux over time

Color indicates origin/destination plot pairings. Panels: left to right - High, Medium, Low salinity; top to bottom - Low, Medium, and High elevation.

```{r, echo = FALSE, warning = FALSE}
daily_treatment_means %>% 
  filter(!is.na(meanFlux), !is.na(sdFlux)) %>% 
  ggplot(aes(x = Timestamp, y = meanFlux, color = Experiment, group = Group)) +
  geom_point() +
  geom_line(aes(linetype = ControlGroup)) +
  geom_errorbar(aes(ymin = meanFlux - sdFlux, ymax = meanFlux + sdFlux)) +
  facet_grid(Dest_Elevation ~ Dest_Salinity) +
  ggtitle("Flux over time - destination plots") +
  labs(x = "Date", y = expression(Flux~(µmol~CO[2]~m^-2~s^-1))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Soil temperature versus CO2 flux for all cores
```{r, echo = FALSE, warning = FALSE}
licor_daily_data %>% 
  filter(!is.na(meanT20), !is.na(meanFlux)) %>% 
  ggplot(aes(x = meanT20, y = meanFlux, color = Dest_Elevation)) +
  geom_point() + geom_smooth(method = "loess") +
  labs(x = "Temperature (degC)", y = "Flux (µmol m-2 s-1)")
```

### Licor soil moisture over time
```{r, echo = FALSE}
daily_treatment_means %>% 
  filter(!is.na(meanSM)) %>% 
  ggplot(aes(x = Timestamp, y = meanSM, color = Experiment, group = Group)) +
  geom_point() +
  geom_line(aes(linetype = ControlGroup)) +
  coord_cartesian(ylim = c(0, 0.6)) +
  facet_grid(Dest_Elevation ~ Dest_Salinity) +
  labs(x = "Date") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Coefficient of variation between collars
```{r, echo = FALSE, warning = FALSE}
licor_data %>% 
  group_by(Date, Group, Collar) %>% 
  summarise(CV = sd(Flux) / mean(Flux), 
            n = n(), 
            Timestamp = mean(Timestamp)) %>%
  filter(!is.na(CV)) %>% 
  ggplot(aes(x = Timestamp, y = CV, color = Group)) +
  geom_point()
```

### Soil temperature at 20CM and 2CM depth
```{r, echo = FALSE, eval = FALSE}
wxfigures$stemp_wxplot
```

### Air temperature and Relative Humidity
```{r, echo = FALSE, eval = FALSE}
wxfigures$TRH_wxplot
```

### Soil moisure at 20CM and 2CM depth
```{r, echo = FALSE, eval = FALSE}
wxfigures$smoisture_wxplot
```

### Histogram of trees by DBH
```{r}
tree_data <- readd("tree_data")
ggplot(tree_data, aes(DBH_cm, fill = Species)) + 
  geom_histogram(position = "stack", binwidth = 5) + 
  facet_grid(Salinity ~ Elevation)
```

